<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SonicStream TWA</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --accent: #d946ef;
            --bg-dark: #000000; /* OLED Black */
            --bg-gradient: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%);
            --glass-bg: rgba(30, 41, 59, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --radius: 16px;
            --nav-height: 70px;
            --player-height: 85px;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }
        .btn-touch { transition: transform 0.1s; cursor: pointer; }
        .btn-touch:active { transform: scale(0.95); opacity: 0.8; }
        .text-gradient { background: linear-gradient(to right, #c084fc, #d946ef); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- LAYOUT --- */
        .app-container { display: flex; height: 100%; width: 100%; position: relative; overflow: hidden; }

        /* SIDEBAR (Desktop) / BOTTOM NAV (Mobile) */
        .nav-bar {
            z-index: 50;
            transition: all 0.3s ease;
        }

        /* Content Area */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            padding-bottom: calc(var(--player-height) + var(--nav-height) + 20px);
            background: var(--bg-gradient);
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-top: 10px;
        }
        .user-badge {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px;
            font-size: 0.8rem;
        }
        .user-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--primary); object-fit: cover; }

        /* TRACK LIST */
        .track-list { display: flex; flex-direction: column; gap: 12px; }
        .track-item {
            display: flex; align-items: center; gap: 15px;
            padding: 12px; border-radius: var(--radius);
            background: rgba(255,255,255,0.03);
            border: 1px solid transparent;
            transition: background 0.2s;
        }
        .track-item:active { background: rgba(255,255,255,0.08); }
        .t-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #333; }
        .t-info { flex: 1; min-width: 0; }
        .t-title { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-artist { font-size: 0.85rem; color: var(--text-muted); }
        .t-actions { display: flex; gap: 15px; color: var(--text-muted); }
        
        /* Source Badge (Bot vs User) */
        .badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        .badge-bot { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-user { background: rgba(168, 85, 247, 0.2); color: #c084fc; }

        /* PLAYER (Floating Bottom Sheet) */
        .player-dock {
            position: fixed; bottom: var(--nav-height); left: 0; width: 100%;
            height: var(--player-height);
            display: flex; align-items: center; padding: 0 15px;
            z-index: 100;
            border-top: 1px solid var(--glass-border);
            transition: bottom 0.3s ease;
        }
        
        .p-mini-img { width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; object-fit: cover; animation: spin 10s linear infinite; animation-play-state: paused; }
        .playing .p-mini-img { animation-play-state: running; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .p-controls { margin-left: auto; display: flex; align-items: center; gap: 20px; }
        .play-fab {
            width: 48px; height: 48px; border-radius: 50%;
            background: white; color: black;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* PROGRESS BAR (Absolute Top of Player) */
        .progress-absolute { position: absolute; top: -2px; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        /* UPLOAD & BOT SYNC UI */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .action-card {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: var(--radius);
            text-align: center; border: 1px dashed var(--glass-border);
        }
        .action-icon { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }

        /* RESPONSIVE STYLES */
        @media (min-width: 769px) {
            /* Desktop Layout */
            .nav-bar {
                position: relative; width: 260px; height: 100%;
                background: rgba(15, 23, 42, 0.9); border-right: 1px solid var(--glass-border);
                display: flex; flex-direction: column; padding: 20px;
            }
            .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-muted); margin-bottom: 5px; }
            .nav-item.active { background: rgba(255,255,255,0.05); color: var(--text); border-left: 3px solid var(--primary); }
            .nav-item span { display: inline; }
            
            .player-dock { width: calc(100% - 260px); left: 260px; bottom: 0; height: 90px; border-radius: 0; }
        }

        @media (max-width: 768px) {
            /* Mobile Layout */
            .nav-bar {
                position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--nav-height) + env(safe-area-inset-bottom));
                background: rgba(10, 10, 10, 0.95);
                backdrop-filter: blur(20px);
                display: flex; justify-content: space-around; align-items: flex-start;
                padding-top: 10px; border-top: 1px solid var(--glass-border);
            }
            .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: #64748b; font-size: 0.7rem; gap: 5px; }
            .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
            .nav-item.active { color: var(--primary); }
            
            .player-dock { bottom: calc(var(--nav-height) + env(safe-area-inset-bottom)); border-radius: 20px 20px 0 0; margin-bottom: -1px; background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(20px); }
        }
    </style>
</head>
<body>

    <!-- AUTH / LOGIN SCREEN (Fallback for Non-Telegram) -->
    <div id="auth-screen" class="glass" style="position:fixed; inset:0; z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px;">
        <div style="font-size:3rem; margin-bottom:20px;" class="text-gradient"><i class="fa-brands fa-telegram"></i></div>
        <h2 style="margin-bottom:10px;">SonicStream TWA</h2>
        <p style="color:var(--text-muted); text-align:center; margin-bottom:30px;">Launch from Telegram for automatic login, or continue as guest.</p>
        <button onclick="manualLogin()" class="glass btn-touch" style="padding:15px 40px; border-radius:30px; color:white; font-weight:600; border:none; background:var(--primary);">
            Continue as Guest
        </button>
    </div>

    <div class="app-container">
        <!-- NAVIGATION -->
        <nav class="nav-bar">
            <div class="nav-item active btn-touch" onclick="navTo('home', this)">
                <i class="fa-solid fa-house-signal"></i>
                <span>Home</span>
            </div>
            <div class="nav-item btn-touch" onclick="navTo('library', this)">
                <i class="fa-solid fa-heart"></i>
                <span>Library</span>
            </div>
            <div class="nav-item btn-touch" onclick="navTo('upload', this)">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <span>Upload</span>
            </div>
            
            <!-- Desktop Only Logo -->
            <div style="margin-top:auto; padding:20px; text-align:center; color:var(--text-muted); font-size:0.8rem;" class="hidden-mobile">
                SonicStream v3.0
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="header">
                <h2 id="page-title" style="font-weight:700; font-size:1.8rem;">Discover</h2>
                <div id="user-display" class="user-badge hidden">
                    <img src="" id="u-avatar" class="user-avatar">
                    <span id="u-name">User</span>
                </div>
            </header>

            <!-- VIEW: HOME -->
            <div id="view-home" class="view-section">
                <!-- Bot Sync Promo -->
                <div class="glass btn-touch" onclick="simulateBotSync()" style="padding:15px; border-radius:12px; display:flex; align-items:center; gap:15px; margin-bottom:20px; background:linear-gradient(90deg, rgba(59,130,246,0.1), transparent);">
                    <div style="background:#3b82f6; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fa-brands fa-telegram text-white"></i></div>
                    <div>
                        <h4 style="font-size:0.95rem; color:#60a5fa;">Sync from Telegram Chat</h4>
                        <p style="font-size:0.75rem; color:var(--text-muted);">Tap to fetch music sent to the bot</p>
                    </div>
                </div>

                <h4 style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">Recent Tracks</h4>
                <div id="track-list" class="track-list">
                    <!-- Tracks Injected Here -->
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div id="view-library" class="view-section hidden">
                <h4 style="color:var(--text-muted); margin-bottom:15px;">Your Collection</h4>
                <div id="library-list" class="track-list"></div>
            </div>

            <!-- VIEW: UPLOAD -->
            <div id="view-upload" class="view-section hidden">
                <div class="action-grid">
                    <div class="action-card btn-touch" onclick="document.getElementById('f-audio').click()">
                        <div class="action-icon"><i class="fa-solid fa-music"></i></div>
                        <div style="font-size:0.8rem;">Select MP3</div>
                    </div>
                    <div class="action-card btn-touch" onclick="document.getElementById('f-cover').click()">
                        <div class="action-icon"><i class="fa-regular fa-image"></i></div>
                        <div style="font-size:0.8rem;">Select Cover</div>
                    </div>
                </div>

                <form id="upload-form" class="glass" style="padding:20px; border-radius:20px;">
                    <input type="file" id="f-audio" accept="audio/*" hidden>
                    <input type="file" id="f-cover" accept="image/*" hidden>
                    
                    <div id="file-status" style="margin-bottom:15px; font-size:0.85rem; color:var(--accent);"></div>

                    <input type="text" id="m-title" placeholder="Track Title" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:none; border-radius:8px; color:white; margin-bottom:10px;">
                    <input type="text" id="m-artist" placeholder="Artist Name" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:none; border-radius:8px; color:white; margin-bottom:20px;">
                    
                    <button type="submit" class="btn-touch" style="width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:600;">Save to Library</button>
                </form>
            </div>
        </main>

        <!-- MINI PLAYER DOCK -->
        <div id="player-dock" class="player-dock hidden">
            <div class="progress-absolute"><div id="p-bar" class="progress-fill"></div></div>
            
            <img src="" id="p-img" class="p-mini-img">
            <div style="flex:1; min-width:0; overflow:hidden;">
                <div id="p-title" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Not Playing</div>
                <div id="p-artist" style="font-size:0.8rem; color:var(--text-muted);">Tap a track</div>
            </div>
            
            <div class="p-controls">
                <i class="fa-solid fa-backward-step btn-touch" style="font-size:1.2rem;" onclick="skip(-1)"></i>
                <div class="play-fab btn-touch" onclick="togglePlay()">
                    <i id="play-icon" class="fa-solid fa-play"></i>
                </div>
                <i class="fa-solid fa-forward-step btn-touch" style="font-size:1.2rem;" onclick="skip(1)"></i>
            </div>
        </div>
    </div>

    <script>
        /* --- TELEGRAM & SYSTEM SETUP --- */
        const tg = window.Telegram.WebApp;
        const KEYS = { TRACKS: 'st_twa_tracks', USER: 'st_twa_user' };
        let audio = new Audio();
        let currentUser = null;
        let currentTrackId = null;
        let queue = [];

        // Init
        window.onload = () => {
            tg.ready();
            tg.expand(); // Fullscreen on Telegram
            
            // Auth Check
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                handleTelegramAuth(tg.initDataUnsafe.user);
            } else {
                // Show manual auth if not in Telegram
                document.getElementById('auth-screen').style.display = 'flex';
            }

            // Theme Match
            if (tg.colorScheme === 'light') {
                // Optional: Override variables for light mode if needed, 
                // but dark mode is preferred for this aesthetic.
            }

            renderTracks();
            setupForm();
        };

        function handleTelegramAuth(tgUser) {
            currentUser = {
                id: tgUser.id,
                name: tgUser.first_name,
                username: tgUser.username,
                avatar: tgUser.photo_url
            };
            
            // UI Update
            document.getElementById('auth-screen').style.display = 'none';
            const userBadge = document.getElementById('user-display');
            userBadge.classList.remove('hidden');
            document.getElementById('u-name').innerText = currentUser.name;
            if(currentUser.avatar) document.getElementById('u-avatar').src = currentUser.avatar;
            else document.getElementById('u-avatar').style.display = 'none';
        }

        function manualLogin() {
            currentUser = { id: 'guest_' + Date.now(), name: 'Guest', username: 'guest' };
            document.getElementById('auth-screen').style.display = 'none';
        }

        /* --- HAPTICS --- */
        function haptic(style = 'light') {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred(style);
            }
        }

        /* --- NAVIGATION --- */
        function navTo(view, el) {
            haptic('light');
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            const titles = { home: 'Discover', library: 'Library', upload: 'Upload' };
            document.getElementById('page-title').innerText = titles[view];

            if(view === 'library') renderLibrary();
        }

        /* --- DATA LOGIC --- */
        function getTracks() {
            const data = localStorage.getItem(KEYS.TRACKS);
            return data ? JSON.parse(data) : [];
        }

        function saveTrack(track) {
            let tracks = getTracks();
            // Enforce storage limit (simple FIFO)
            if (JSON.stringify(tracks).length > 4500000) {
                tracks.pop(); // Remove oldest
                tg.showAlert("Storage full, oldest track removed.");
            }
            tracks.unshift(track);
            localStorage.setItem(KEYS.TRACKS, JSON.stringify(tracks));
            renderTracks();
            navTo('home', document.querySelector('.nav-item:nth-child(1)'));
        }

        /* --- UPLOAD FORM --- */
        function setupForm() {
            const fAudio = document.getElementById('f-audio');
            const fCover = document.getElementById('f-cover');
            
            const updateStatus = () => {
                const a = fAudio.files[0]?.name;
                const c = fCover.files[0]?.name;
                document.getElementById('file-status').innerText = a ? `Ready: ${a} ${c?'+ Cover':''}` : '';
            };
            
            fAudio.onchange = updateStatus;
            fCover.onchange = updateStatus;

            document.getElementById('upload-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!fAudio.files[0]) return tg.showAlert("Please select an MP3 file.");
                
                tg.MainButton.showProgress(); // Native Telegram Spinner
                
                try {
                    const audioData = await toBase64(fAudio.files[0]);
                    const coverData = fCover.files[0] ? await toBase64(fCover.files[0]) : null;
                    
                    const track = {
                        id: Date.now().toString(),
                        title: document.getElementById('m-title').value || "Unknown Track",
                        artist: document.getElementById('m-artist').value || "Unknown Artist",
                        audio: audioData,
                        cover: coverData,
                        source: 'user', // Track origin
                        uploaderId: currentUser.id
                    };
                    
                    saveTrack(track);
                    haptic('success');
                    document.getElementById('upload-form').reset();
                    document.getElementById('file-status').innerText = '';
                } catch (err) {
                    tg.showAlert("Error: File likely too large.");
                } finally {
                    tg.MainButton.hideProgress();
                }
            });
        }

        /* --- BOT SYNC SIMULATION --- */
        function simulateBotSync() {
            haptic('medium');
            tg.showConfirm("Import 'Demo Track' from Telegram Bot chat history?", (confirmed) => {
                if(confirmed) {
                    // Create a fake track as if it came from the bot
                    const demoTrack = {
                        id: 'bot_' + Date.now(),
                        title: "Telegram Bot Demo",
                        artist: "Bot Sync",
                        audio: "", // Empty audio for demo to save space, logic holds
                        cover: null,
                        source: 'bot',
                        uploaderId: currentUser.id
                    };
                    // Note: Real implementation would fetch URL from backend
                    saveTrack(demoTrack);
                    tg.showAlert("Synced 1 track from Bot!");
                }
            });
        }

        /* --- RENDERING --- */
        function renderTracks() {
            const tracks = getTracks();
            queue = tracks.map(t => t.id);
            
            const html = tracks.map(t => `
                <div class="track-item btn-touch" onclick="playTrack('${t.id}')">
                    <img src="${t.cover || 'https://via.placeholder.com/50/333/fff?text=♪'}" class="t-img">
                    <div class="t-info">
                        <div class="t-title">${t.title} <span class="badge ${t.source==='bot'?'badge-bot':'badge-user'}">${t.source}</span></div>
                        <div class="t-artist">${t.artist}</div>
                    </div>
                    <div class="t-actions">
                        <i class="fa-solid fa-ellipsis-vertical" onclick="event.stopPropagation(); showTrackOptions('${t.id}')"></i>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('track-list').innerHTML = html || '<div style="text-align:center; padding:40px; color:var(--text-muted)">No tracks found</div>';
        }

        function renderLibrary() {
            // In a real app, filter by favorites. Here, simple duplicate of list for structure.
            const tracks = getTracks().filter(t => t.uploaderId === currentUser.id);
            const html = tracks.map(t => `
                <div class="track-item btn-touch" onclick="playTrack('${t.id}')">
                    <img src="${t.cover || 'https://via.placeholder.com/50/333/fff?text=♪'}" class="t-img">
                    <div class="t-info">
                        <div class="t-title">${t.title}</div>
                        <div class="t-artist">${t.artist}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('library-list').innerHTML = html || '<div style="text-align:center; padding:40px; color:var(--text-muted)">You haven\'t uploaded anything yet.</div>';
        }

        function showTrackOptions(id) {
            haptic('light');
            tg.showPopup({
                title: 'Track Options',
                message: 'What do you want to do?',
                buttons: [{id: 'del', type: 'destructive', text: 'Delete Track'}, {type: 'cancel'}]
            }, (btnId) => {
                if (btnId === 'del') deleteTrack(id);
            });
        }

        function deleteTrack(id) {
            let tracks = getTracks().filter(t => t.id !== id);
            localStorage.setItem(KEYS.TRACKS, JSON.stringify(tracks));
            renderTracks();
            if(currentTrackId === id) {
                audio.pause();
                document.getElementById('player-dock').classList.add('hidden');
            }
        }

        /* --- PLAYER LOGIC --- */
        function playTrack(id) {
            const tracks = getTracks();
            const track = tracks.find(t => t.id === id);
            if(!track) return;

            // Simulate failure if audio is empty (Bot Demo)
            if(track.audio === "") {
                return tg.showAlert("This is a demo entry from the bot. No actual audio file attached in simulation.");
            }

            haptic('medium');
            currentTrackId = id;
            audio.src = track.audio;
            audio.play();
            
            // UI
            document.getElementById('player-dock').classList.remove('hidden');
            document.getElementById('p-title').innerText = track.title;
            document.getElementById('p-artist').innerText = track.artist;
            document.getElementById('p-img').src = track.cover || 'https://via.placeholder.com/50/333/fff?text=♪';
            
            updatePlayIcon(true);
        }

        function togglePlay() {
            haptic('light');
            if(audio.paused) {
                audio.play();
                updatePlayIcon(true);
            } else {
                audio.pause();
                updatePlayIcon(false);
            }
        }

        function updatePlayIcon(isPlaying) {
            const icon = document.getElementById('play-icon');
            const dock = document.getElementById('player-dock');
            if(isPlaying) {
                icon.className = 'fa-solid fa-pause';
                dock.classList.add('playing');
            } else {
                icon.className = 'fa-solid fa-play';
                dock.classList.remove('playing');
            }
        }

        function skip(dir) {
            haptic('light');
            const idx = queue.indexOf(currentTrackId);
            let nextIdx = idx + dir;
            if(nextIdx >= queue.length) nextIdx = 0;
            if(nextIdx < 0) nextIdx = queue.length - 1;
            playTrack(queue[nextIdx]);
        }

        audio.addEventListener('timeupdate', () => {
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('p-bar').style.width = pct + '%';
        });

        audio.addEventListener('ended', () => skip(1));

        /* --- HELPERS --- */
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>